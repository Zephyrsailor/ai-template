# MCPæœåŠ¡å®Œæ•´è®¾è®¡ä¸å®ç°æŒ‡å—

## ğŸ“‹ ç›®å½•
1. [æ¶æ„æ¦‚è§ˆ](#æ¶æ„æ¦‚è§ˆ)
2. [æ ¸å¿ƒè®¾è®¡ç†å¿µ](#æ ¸å¿ƒè®¾è®¡ç†å¿µ)
3. [ç³»ç»Ÿæ¶æ„æµç¨‹å›¾](#ç³»ç»Ÿæ¶æ„æµç¨‹å›¾)
4. [æ ¸å¿ƒä»£ç å®ç°](#æ ¸å¿ƒä»£ç å®ç°)
5. [æ€§èƒ½ä¼˜åŒ–ç­–ç•¥](#æ€§èƒ½ä¼˜åŒ–ç­–ç•¥)
6. [æ‰©å±•æ€§è®¾è®¡](#æ‰©å±•æ€§è®¾è®¡)

## ğŸ—ï¸ æ¶æ„æ¦‚è§ˆ

### ç³»ç»Ÿæ•´ä½“æ¶æ„
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    å‰ç«¯å±‚ (Frontend)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   MCPç®¡ç†ç•Œé¢    â”‚    èŠå¤©ç•Œé¢      â”‚     MCPé€‰æ‹©å™¨           â”‚
â”‚   - æœåŠ¡å™¨CRUD   â”‚   - å·¥å…·è°ƒç”¨     â”‚    - å®æ—¶çŠ¶æ€æ˜¾ç¤º       â”‚
â”‚   - è¿æ¥æ§åˆ¶     â”‚   - æµå¼å¯¹è¯     â”‚    - æœåŠ¡å™¨é€‰æ‹©         â”‚
â”‚   - çŠ¶æ€ç›‘æ§     â”‚   - ä¸Šä¸‹æ–‡ç®¡ç†   â”‚                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    APIå±‚ (API Gateway)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   MCP APIè·¯ç”±    â”‚   èŠå¤©APIè·¯ç”±    â”‚     è®¤è¯ä¸­é—´ä»¶          â”‚
â”‚   - /api/mcp/*  â”‚   - /api/chat/* â”‚    - JWTéªŒè¯            â”‚
â”‚   - RESTfulè®¾è®¡  â”‚   - æµå¼å“åº”     â”‚    - ç”¨æˆ·éš”ç¦»           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æœåŠ¡å±‚ (Service Layer)                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚   MCPService    â”‚   ChatService   â”‚   ConnectionPool        â”‚
â”‚   - æœåŠ¡å™¨ç®¡ç†   â”‚   - å¯¹è¯å¤„ç†     â”‚   - è¿æ¥ç®¡ç†            â”‚
â”‚   - è¿æ¥åè°ƒ     â”‚   - å·¥å…·é›†æˆ     â”‚   - å¥åº·ç›‘æ§            â”‚
â”‚   - å·¥å…·ä»£ç†     â”‚   - ä¸Šä¸‹æ–‡æ„å»º   â”‚   - æ•…éšœæ¢å¤            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   æ•°æ®å±‚ (Data Layer)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  MCPRepository  â”‚    Database     â”‚     MCPç”Ÿæ€ç³»ç»Ÿ         â”‚
â”‚  - æœåŠ¡å™¨é…ç½®    â”‚   - æŒä¹…åŒ–å­˜å‚¨   â”‚   - æ–‡ä»¶ç³»ç»ŸæœåŠ¡å™¨       â”‚
â”‚  - çŠ¶æ€ç®¡ç†     â”‚   - ç”¨æˆ·æ•°æ®     â”‚   - è‡ªå®šä¹‰å·¥å…·æœåŠ¡å™¨     â”‚
â”‚  - æƒé™æ§åˆ¶     â”‚   - ä¼šè¯å†å²     â”‚   - ç¬¬ä¸‰æ–¹é›†æˆ          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æ ¸å¿ƒè®¾è®¡ç†å¿µ

### 1. å…¨å±€è¿æ¥æ±  + ç”¨æˆ·éš”ç¦»
**è®¾è®¡ç›®æ ‡ï¼š** è§£å†³è¿æ¥ä¸ç¨³å®šã€çŠ¶æ€ä¸åŒæ­¥ã€å¯åŠ¨ç¼“æ…¢ç­‰é—®é¢˜

**æ ¸å¿ƒç‰¹æ€§ï¼š**
- âœ… **è¿æ¥ä¸€è‡´æ€§**ï¼šèŠå¤©å’Œç®¡ç†ç•Œé¢å…±äº«ç›¸åŒè¿æ¥å®ä¾‹
- âœ… **å¹¶å‘ä¼˜åŒ–**ï¼šæ”¯æŒå¹¶è¡Œè¿æ¥ï¼Œé¿å…ä¸²è¡Œé˜»å¡
- âœ… **æ•…éšœéš”ç¦»**ï¼šå•ä¸ªæœåŠ¡å™¨æ•…éšœä¸å½±å“å…¶ä»–æœåŠ¡å™¨
- âœ… **è‡ªåŠ¨æ¢å¤**ï¼šæ™ºèƒ½é‡è¿æœºåˆ¶ï¼Œæé«˜ç³»ç»Ÿç¨³å®šæ€§

### 2. å¼‚æ­¥ä¼˜å…ˆæ¶æ„
**è®¾è®¡åŸåˆ™ï¼š** æ‰€æœ‰I/Oæ“ä½œé‡‡ç”¨å¼‚æ­¥æ¨¡å¼ï¼Œé¿å…é˜»å¡

**å®ç°ç­–ç•¥ï¼š**
- å¼‚æ­¥è¿æ¥åˆ›å»ºå’Œç®¡ç†
- å¼‚æ­¥å·¥å…·è°ƒç”¨å’Œç»“æœå¤„ç†
- å¼‚æ­¥å¥åº·æ£€æŸ¥å’Œæ•…éšœæ¢å¤
- æµå¼å“åº”å¤„ç†

### 3. åˆ†å±‚è§£è€¦è®¾è®¡
**æ¶æ„åˆ†å±‚ï¼š**
- **è¡¨ç°å±‚**ï¼šå‰ç«¯UIç»„ä»¶ï¼Œè´Ÿè´£ç”¨æˆ·äº¤äº’
- **æ¥å£å±‚**ï¼šAPIè·¯ç”±ï¼Œè´Ÿè´£è¯·æ±‚å¤„ç†å’Œå“åº”
- **ä¸šåŠ¡å±‚**ï¼šæœåŠ¡ç±»ï¼Œè´Ÿè´£ä¸šåŠ¡é€»è¾‘åè°ƒ
- **æ•°æ®å±‚**ï¼šRepositoryï¼Œè´Ÿè´£æ•°æ®æŒä¹…åŒ–
- **åŸºç¡€å±‚**ï¼šè¿æ¥æ± ï¼Œè´Ÿè´£åº•å±‚è¿æ¥ç®¡ç†

## ğŸ”„ ç³»ç»Ÿæ¶æ„æµç¨‹å›¾

### 1. æ•´ä½“æ¶æ„å›¾
```mermaid
graph TB
    subgraph "å‰ç«¯å±‚ Frontend"
        UI[ç”¨æˆ·ç•Œé¢]
        MCPManager[MCPç®¡ç†å™¨]
        ChatInterface[èŠå¤©ç•Œé¢]
        MCPSelector[MCPé€‰æ‹©å™¨]
    end
    
    subgraph "APIå±‚ API Layer"
        MCPRoutes[MCPè·¯ç”±]
        ChatRoutes[èŠå¤©è·¯ç”±]
        AuthMiddleware[è®¤è¯ä¸­é—´ä»¶]
    end
    
    subgraph "æœåŠ¡å±‚ Service Layer"
        MCPService[MCPæœåŠ¡]
        ChatService[èŠå¤©æœåŠ¡]
        ConnectionPool[è¿æ¥æ± ]
    end
    
    subgraph "æ•°æ®å±‚ Data Layer"
        MCPRepository[MCPä»“å‚¨]
        Database[(æ•°æ®åº“)]
    end
    
    subgraph "MCPç”Ÿæ€ MCP Ecosystem"
        MCPHub[MCP Hub]
        FileSystem[æ–‡ä»¶ç³»ç»ŸæœåŠ¡å™¨]
        WebSearch[ç½‘ç»œæœç´¢æœåŠ¡å™¨]
        CustomTool[è‡ªå®šä¹‰å·¥å…·æœåŠ¡å™¨]
    end
    
    UI --> MCPManager
    UI --> ChatInterface
    ChatInterface --> MCPSelector
    
    MCPManager --> MCPRoutes
    ChatInterface --> ChatRoutes
    MCPSelector --> MCPRoutes
    
    MCPRoutes --> AuthMiddleware
    ChatRoutes --> AuthMiddleware
    
    AuthMiddleware --> MCPService
    AuthMiddleware --> ChatService
    
    MCPService --> ConnectionPool
    MCPService --> MCPRepository
    ChatService --> MCPService
    
    MCPRepository --> Database
    
    ConnectionPool --> MCPHub
    MCPHub --> FileSystem
    MCPHub --> WebSearch
    MCPHub --> CustomTool
    
    style ConnectionPool fill:#e1f5fe
    style MCPHub fill:#f3e5f5
    style MCPService fill:#e8f5e8
```

### 2. æœåŠ¡å™¨åˆ›å»ºæµç¨‹
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant UI as å‰ç«¯ç•Œé¢
    participant API as APIå±‚
    participant MCP as MCPService
    participant Pool as ConnectionPool
    participant Hub as MCPHub
    participant Server as MCPæœåŠ¡å™¨
    
    Note over U,Server: æœåŠ¡å™¨åˆ›å»ºå’Œè¿æ¥æµç¨‹
    U->>UI: åˆ›å»ºMCPæœåŠ¡å™¨
    UI->>API: POST /api/mcp/servers
    API->>MCP: create_server()
    MCP->>MCP: éªŒè¯é…ç½®
    MCP->>Pool: ensure_connection()
    Pool->>Hub: åˆ›å»ºHubå®ä¾‹
    Hub->>Server: å»ºç«‹è¿æ¥
    Server-->>Hub: è¿æ¥æˆåŠŸ
    Hub-->>Pool: è¿æ¥å°±ç»ª
    Pool-->>MCP: è¿æ¥å®Œæˆ
    MCP-->>API: æœåŠ¡å™¨åˆ›å»ºæˆåŠŸ
    API-->>UI: è¿”å›æœåŠ¡å™¨ä¿¡æ¯
```

### 3. èŠå¤©å·¥å…·è°ƒç”¨æµç¨‹
```mermaid
sequenceDiagram
    participant U as ç”¨æˆ·
    participant UI as èŠå¤©ç•Œé¢
    participant API as èŠå¤©API
    participant Chat as ChatService
    participant MCP as MCPService
    participant Pool as ConnectionPool
    participant Hub as MCPHub
    participant Tool as å·¥å…·æœåŠ¡å™¨
    
    Note over U,Tool: èŠå¤©ä¸­çš„å·¥å…·è°ƒç”¨æµç¨‹
    U->>UI: å‘é€æ¶ˆæ¯ï¼ˆé€‰æ‹©MCPæœåŠ¡å™¨ï¼‰
    UI->>API: POST /api/chat/stream
    API->>Chat: chat_stream()
    Chat->>MCP: get_user_tools()
    MCP->>Pool: get_user_connections()
    Pool-->>MCP: è¿”å›å¯ç”¨è¿æ¥
    MCP-->>Chat: è¿”å›å·¥å…·åˆ—è¡¨
    Chat->>Chat: æ„å»ºèŠå¤©ä¸Šä¸‹æ–‡
    Note over Chat: LLMå†³å®šè°ƒç”¨å·¥å…·
    Chat->>MCP: call_tool()
    MCP->>Pool: è·å–è¿æ¥
    Pool->>Hub: è°ƒç”¨å·¥å…·
    Hub->>Tool: æ‰§è¡Œå·¥å…·
    Tool-->>Hub: è¿”å›ç»“æœ
    Hub-->>Pool: å·¥å…·ç»“æœ
    Pool-->>MCP: å·¥å…·ç»“æœ
    MCP-->>Chat: å·¥å…·ç»“æœ
    Chat-->>API: æµå¼è¿”å›ç»“æœ
    API-->>UI: æ˜¾ç¤ºå·¥å…·æ‰§è¡Œç»“æœ
```

### 4. è¿æ¥æ± ç®¡ç†æµç¨‹
```mermaid
graph TD
    A[è¿æ¥è¯·æ±‚] --> B{è¿æ¥æ˜¯å¦å­˜åœ¨?}
    
    B -->|æ˜¯| C[æ£€æŸ¥è¿æ¥å¥åº·]
    B -->|å¦| D[åˆ›å»ºæ–°è¿æ¥]
    
    C --> E{è¿æ¥å¥åº·?}
    E -->|æ˜¯| F[è¿”å›ç°æœ‰è¿æ¥]
    E -->|å¦| G[æ ‡è®°ä¸ºä¸å¥åº·]
    
    D --> H[é…ç½®æœåŠ¡å™¨å‚æ•°]
    H --> I[åˆ›å»ºMCPHubå®ä¾‹]
    I --> J[å»ºç«‹è¿æ¥]
    J --> K{è¿æ¥æˆåŠŸ?}
    
    K -->|æ˜¯| L[å­˜å‚¨è¿æ¥]
    K -->|å¦| M[æ ‡è®°ä¸ºå¤±è´¥]
    
    G --> N[å°è¯•é‡è¿]
    M --> O[è®°å½•é”™è¯¯]
    L --> P[æ ‡è®°ä¸ºå·²è¿æ¥]
    N --> Q{é‡è¿æˆåŠŸ?}
    
    Q -->|æ˜¯| P
    Q -->|å¦| O
    
    F --> R[ä½¿ç”¨è¿æ¥]
    P --> R
    O --> S[è¿”å›é”™è¯¯]
    
    style A fill:#e3f2fd
    style R fill:#e8f5e8
    style S fill:#ffebee
```

### 5. å¥åº·æ£€æŸ¥æµç¨‹
```mermaid
graph TD
    A[å¯åŠ¨å¥åº·æ£€æŸ¥å¾ªç¯] --> B[ç­‰å¾…30ç§’]
    B --> C[éå†æ‰€æœ‰ç”¨æˆ·è¿æ¥]
    C --> D[éå†ç”¨æˆ·çš„æ‰€æœ‰æœåŠ¡å™¨]
    D --> E[æ‰§è¡Œpingæµ‹è¯•]
    E --> F{æµ‹è¯•æˆåŠŸ?}
    
    F -->|æ˜¯| G[æ ‡è®°ä¸ºconnected]
    F -->|å¦| H[æ ‡è®°ä¸ºdisconnected]
    
    G --> I{è¿˜æœ‰æ›´å¤šæœåŠ¡å™¨?}
    H --> J[è®°å½•é”™è¯¯æ—¥å¿—]
    J --> K[å¯é€‰ï¼šè§¦å‘é‡è¿]
    K --> I
    
    I -->|æ˜¯| D
    I -->|å¦| L{è¿˜æœ‰æ›´å¤šç”¨æˆ·?}
    
    L -->|æ˜¯| C
    L -->|å¦| B
    
    style A fill:#e3f2fd
    style G fill:#e8f5e8
    style H fill:#ffebee
```

## ğŸ”§ æ ¸å¿ƒä»£ç å®ç°

### 1. MCPConnectionPool - è¿æ¥æ± æ ¸å¿ƒ
```python
class MCPConnectionPool:
    """å…¨å±€MCPè¿æ¥æ±  - å•ä¾‹æ¨¡å¼"""
    
    _instance = None
    
    def __new__(cls):
        if cls._instance is None:
            cls._instance = super().__new__(cls)
        return cls._instance
    
    def __init__(self):
        if hasattr(self, '_initialized'):
            return
        
        # è¿æ¥å­˜å‚¨: {user_id: {server_id: MCPHub}}
        self._connections: Dict[str, Dict[str, MCPHub]] = {}
        # çŠ¶æ€è·Ÿè¸ª: {user_id: {server_id: "connecting|connected|disconnected"}}
        self._connection_status: Dict[str, Dict[str, str]] = {}
        self._lock = asyncio.Lock()
        self._initialized = True
        
        # å¯åŠ¨å¥åº·æ£€æŸ¥
        asyncio.create_task(self._health_check_loop())
    
    async def ensure_connection(self, server: MCPServer, user_id: str) -> None:
        """ç¡®ä¿è¿æ¥å­˜åœ¨ - æ”¯æŒå¹¶å‘åˆ›å»º"""
        server_key = f"{user_id}:{server.id}"
        
        async with self._lock:
            # åˆå§‹åŒ–ç”¨æˆ·è¿æ¥å­—å…¸
            if user_id not in self._connections:
                self._connections[user_id] = {}
                self._connection_status[user_id] = {}
            
            # æ£€æŸ¥è¿æ¥æ˜¯å¦å·²å­˜åœ¨
            if server.id not in self._connections[user_id]:
                # æ ‡è®°ä¸ºè¿æ¥ä¸­ï¼Œé˜²æ­¢é‡å¤åˆ›å»º
                self._connection_status[user_id][server.id] = "connecting"
                
                # å¼‚æ­¥åˆ›å»ºè¿æ¥ï¼ˆä¸é˜»å¡å…¶ä»–è¿æ¥ï¼‰
                asyncio.create_task(self._create_connection(server, user_id, server_key))
    
    async def _create_connection(self, server: MCPServer, user_id: str, server_key: str) -> None:
        """åˆ›å»ºæ–°çš„MCPè¿æ¥"""
        try:
            # æ„å»ºæœåŠ¡å™¨é…ç½®
            config = self._build_server_config(server, user_id)
            
            # åˆ›å»ºHubå®ä¾‹
            hub = MCPHub(config)
            await asyncio.wait_for(hub.start(), timeout=10.0)
            
            # å­˜å‚¨è¿æ¥
            self._connections[user_id][server.id] = hub
            self._connection_status[user_id][server.id] = "connected"
            
            logger.info(f"MCPè¿æ¥åˆ›å»ºæˆåŠŸ: {server_key}")
            
        except Exception as e:
            self._connection_status[user_id][server.id] = "disconnected"
            logger.error(f"MCPè¿æ¥åˆ›å»ºå¤±è´¥ {server_key}: {str(e)}")
    
    async def _health_check_loop(self):
        """å¥åº·æ£€æŸ¥å¾ªç¯ - æ¯30ç§’æ£€æŸ¥æ‰€æœ‰è¿æ¥"""
        while True:
            await asyncio.sleep(30)
            
            # éå†æ‰€æœ‰ç”¨æˆ·çš„æ‰€æœ‰è¿æ¥
            for user_id, user_connections in list(self._connections.items()):
                for server_id, hub in list(user_connections.items()):
                    try:
                        # ç®€å•çš„pingæµ‹è¯•
                        await asyncio.wait_for(hub.list_tools(), timeout=5.0)
                        self._connection_status[user_id][server_id] = "connected"
                    except Exception as e:
                        logger.warning(f"å¥åº·æ£€æŸ¥å¤±è´¥ {user_id}:{server_id}: {str(e)}")
                        self._connection_status[user_id][server_id] = "disconnected"
```

### 2. MCPService - ä¸šåŠ¡åè°ƒå™¨
```python
class MCPService(BaseService[MCPServer, MCPRepository]):
    """MCPä¸šåŠ¡æœåŠ¡ - åè°ƒè¿æ¥æ± å’Œæ•°æ®åº“"""
    
    def __init__(self, session: AsyncSession):
        super().__init__(MCPRepository(session))
        self.connection_pool = MCPConnectionPool()  # å…¨å±€è¿æ¥æ± 
    
    async def get_user_tools(self, user_id: str, server_ids: Optional[List[str]] = None) -> List[Tool]:
        """è·å–ç”¨æˆ·å·¥å…·åˆ—è¡¨ - ä¼˜å…ˆä½¿ç”¨è¿æ¥æ± """
        try:
            # ğŸ”¥ ä¼˜å…ˆä½¿ç”¨è¿æ¥æ± ä¸­çš„è¿æ¥
            user_connections = await self.connection_pool.get_user_connections(user_id)
            
            if user_connections:
                tools = []
                for server_id, hub in user_connections.items():
                    # è¿‡æ»¤æŒ‡å®šçš„æœåŠ¡å™¨
                    if server_ids and server_id not in server_ids:
                        continue
                    
                    try:
                        tools_result = await hub.list_tools()
                        if hasattr(tools_result, 'tools') and tools_result.tools:
                            for tool in tools_result.tools:
                                tool_obj = Tool(
                                    name=tool.name,
                                    description=tool.description or "",
                                    parameters=self._convert_tool_parameters(tool.inputSchema)
                                )
                                tools.append(tool_obj)
                    except Exception as e:
                        logger.warning(f"ä»è¿æ¥æ± è·å–å·¥å…·å¤±è´¥ {server_id}: {str(e)}")
                        continue
                
                return tools
            else:
                # å›é€€åˆ°ä¸´æ—¶Hubåˆ›å»º
                return await self._fallback_get_tools(user_id, server_ids)
                
        except Exception as e:
            logger.error(f"è·å–ç”¨æˆ·å·¥å…·å¤±è´¥: {str(e)}")
            return []
    
    async def call_tool(self, user_id: str, tool_name: str, arguments: Dict[str, Any]) -> Dict[str, Any]:
        """è°ƒç”¨MCPå·¥å…· - ä½¿ç”¨è¿æ¥æ± ä¸­çš„è¿æ¥"""
        try:
            # ğŸ”¥ ä¼˜å…ˆä½¿ç”¨è¿æ¥æ± ä¸­çš„è¿æ¥
            user_connections = await self.connection_pool.get_user_connections(user_id)
            
            if user_connections:
                # å°è¯•åœ¨ç°æœ‰è¿æ¥ä¸­è°ƒç”¨å·¥å…·
                for server_id, hub in user_connections.items():
                    try:
                        result = await asyncio.wait_for(
                            hub.call_tool(tool_name, arguments),
                            timeout=30.0
                        )
                        
                        # æ ¼å¼åŒ–è¿”å›ç»“æœ
                        return self._format_tool_result(result)
                        
                    except Exception as e:
                        logger.warning(f"è¿æ¥æ± è°ƒç”¨å·¥å…·å¤±è´¥ {server_id}: {str(e)}")
                        continue
                
                # æ‰€æœ‰è¿æ¥éƒ½å¤±è´¥
                return {"success": False, "error": "æ‰€æœ‰è¿æ¥éƒ½æ— æ³•è°ƒç”¨è¯¥å·¥å…·"}
            else:
                # å›é€€åˆ°ä¸´æ—¶Hub
                return await self._fallback_tool_call(user_id, tool_name, arguments)
                
        except Exception as e:
            logger.error(f"è°ƒç”¨å·¥å…·å¤±è´¥: {str(e)}")
            return {"success": False, "error": str(e)}
    
    async def refresh_server_connection(self, server_id: str, user_id: str) -> MCPServerStatus:
        """åˆ·æ–°/é‡è¿MCPæœåŠ¡å™¨è¿æ¥"""
        server = await self.repository.get_user_server(server_id, user_id)
        if not server:
            raise NotFoundException(f"MCPæœåŠ¡å™¨ {server_id} ä¸å­˜åœ¨")
        
        if not server.active:
            raise ValidationException(f"æœåŠ¡å™¨ {server.name} æœªæ¿€æ´»ï¼Œæ— æ³•é‡è¿")
        
        try:
            # å…ˆç§»é™¤ç°æœ‰è¿æ¥
            await self.connection_pool.remove_connection(server_id, user_id)
            
            # é‡æ–°åˆ›å»ºè¿æ¥
            await self.connection_pool.ensure_connection(server, user_id)
            
            # ç­‰å¾…è¿æ¥å®Œæˆï¼ˆæœ€å¤šç­‰å¾…5ç§’ï¼‰
            for _ in range(10):
                status = self.connection_pool.get_connection_status(server_id, user_id)
                if status == "connected":
                    break
                await asyncio.sleep(0.5)
            
            return await self.get_server_status(server_id, user_id)
            
        except Exception as e:
            logger.error(f"åˆ·æ–°æœåŠ¡å™¨è¿æ¥å¤±è´¥: {str(e)}")
            raise ServiceException(f"åˆ·æ–°è¿æ¥å¤±è´¥: {str(e)}")
```

### 3. ChatService - èŠå¤©é›†æˆ
```python
class ChatService:
    """èŠå¤©æœåŠ¡ - é›†æˆMCPå·¥å…·"""
    
    async def build_mcp_tools(self, request: ChatRequest) -> Tuple[Optional[List[Tool]], List[Any]]:
        """æ„å»ºMCPå·¥å…·å’ŒæœåŠ¡å™¨åˆ—è¡¨"""
        if not request.mcp_server_ids or not self.mcp_service:
            return None, []
        
        try:
            # è·å–æœåŠ¡å™¨ä¿¡æ¯
            mcp_servers = []
            for server_id in request.mcp_server_ids:
                server = await self.mcp_service.get_server(server_id, self.current_user.id)
                if server:
                    mcp_servers.append(server)
            
            if mcp_servers:
                # è·å–å·¥å…·åˆ—è¡¨ï¼ˆä½¿ç”¨è¿æ¥æ± ï¼‰
                tools = await self.mcp_service.get_user_tools(
                    self.current_user.id, 
                    request.mcp_server_ids
                )
                return tools, mcp_servers
                
        except Exception as e:
            logger.error(f"MCPå·¥å…·æ„å»ºå¤±è´¥: {str(e)}")
            raise HTTPException(status_code=500, detail=f"MCPå·¥å…·å¤„ç†å¤±è´¥: {str(e)}")
        
        return None, []
    
    async def _safe_call_tool(self, tool_name: str, arguments: Dict[str, Any]) -> Any:
        """å®‰å…¨åœ°è°ƒç”¨å·¥å…·"""
        try:
            # é€šè¿‡MCP Serviceè°ƒç”¨å·¥å…·ï¼ˆä½¿ç”¨è¿æ¥æ± ï¼‰
            result = await self.mcp_service.call_tool(self.current_user.id, tool_name, arguments)
            return result
        except Exception as e:
            logger.error(f"å·¥å…·è°ƒç”¨å¤±è´¥ {tool_name}: {str(e)}")
            raise
```

### 4. APIè·¯ç”±è®¾è®¡
```python
# backend/app/api/routes/mcp.py
@router.get("/servers", response_model=ServerListResponse)
async def list_servers(
    active_only: bool = Query(False, description="æ˜¯å¦åªè¿”å›æ´»è·ƒæœåŠ¡å™¨"),
    connected_only: bool = Query(False, description="æ˜¯å¦åªè¿”å›å·²è¿æ¥çš„æœåŠ¡å™¨ï¼ˆèŠå¤©åœºæ™¯ï¼‰"),
    user_specific: bool = Query(True, description="ç”¨æˆ·ç‰¹å®šæ•°æ®"),
    current_user: User = Depends(get_current_user),
    mcp_service: MCPService = Depends(get_mcp_service)
):
    """è·å–ç”¨æˆ·çš„MCPæœåŠ¡å™¨åˆ—è¡¨ - æ”¯æŒä¸åŒä½¿ç”¨åœºæ™¯"""
    try:
        if connected_only:
            # èŠå¤©åœºæ™¯ï¼šåªè¿”å›å·²è¿æ¥çš„æœåŠ¡å™¨
            statuses = await mcp_service.get_connected_server_statuses(current_user.id)
            servers = []
            for status in statuses:
                server = await mcp_service.get_server(status.server_id, current_user.id)
                servers.append(server)
            return api_response(data=servers)
        else:
            # ç®¡ç†åœºæ™¯ï¼šè¿”å›æ‰€æœ‰æœåŠ¡å™¨
            servers = await mcp_service.list_servers(current_user.id, active_only)
            return api_response(data=servers)
    except Exception as e:
        return api_response(code=500, message=f"è·å–æœåŠ¡å™¨åˆ—è¡¨å¤±è´¥: {str(e)}")

@router.post("/servers/{server_id}/refresh", response_model=ConnectionTestResponse)
async def refresh_server_connection(
    server_id: str = Path(..., description="æœåŠ¡å™¨ID"),
    current_user: User = Depends(get_current_user),
    mcp_service: MCPService = Depends(get_mcp_service)
):
    """åˆ·æ–°/é‡è¿MCPæœåŠ¡å™¨è¿æ¥"""
    try:
        status = await mcp_service.refresh_server_connection(server_id, current_user.id)
        
        success = status.connected and status.healthy
        message = "æœåŠ¡å™¨è¿æ¥åˆ·æ–°æˆåŠŸ" if success else f"æœåŠ¡å™¨è¿æ¥åˆ·æ–°å¤±è´¥: {status.error_message}"
        
        result = MCPConnectionTest(
            success=success,
            message=message,
            latency_ms=0,
            capabilities=status.capabilities
        )
        
        return api_response(data=result, message=message)
    except NotFoundException as e:
        return api_response(code=404, message=str(e))
    except Exception as e:
        return api_response(code=500, message=f"åˆ·æ–°æœåŠ¡å™¨è¿æ¥å¤±è´¥: {str(e)}")
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å¹¶å‘è¿æ¥ä¼˜åŒ–
```python
# æ‰¹é‡å¹¶å‘è¿æ¥ï¼Œé¿å…ä¸²è¡Œé˜»å¡
async def batch_ensure_connections(servers: List[MCPServer], user_id: str):
    batch_size = 3  # æœ€å¤šåŒæ—¶è¿æ¥3ä¸ªæœåŠ¡å™¨
    semaphore = asyncio.Semaphore(batch_size)
    
    async def connect_with_semaphore(server):
        async with semaphore:
            await connection_pool.ensure_connection(server, user_id)
    
    # å¹¶å‘æ‰§è¡Œè¿æ¥
    tasks = [connect_with_semaphore(server) for server in servers]
    await asyncio.gather(*tasks, return_exceptions=True)
```

### 2. è¶…æ—¶æ§åˆ¶ç­–ç•¥
```python
# åˆ†å±‚è¶…æ—¶æ§åˆ¶
TIMEOUTS = {
    "connection": 10.0,    # è¿æ¥å»ºç«‹è¶…æ—¶
    "tool_call": 30.0,     # å·¥å…·è°ƒç”¨è¶…æ—¶
    "health_check": 5.0,   # å¥åº·æ£€æŸ¥è¶…æ—¶
}

async def safe_tool_call(hub: MCPHub, tool_name: str, arguments: Dict):
    try:
        result = await asyncio.wait_for(
            hub.call_tool(tool_name, arguments),
            timeout=TIMEOUTS["tool_call"]
        )
        return result
    except asyncio.TimeoutError:
        raise ToolCallTimeoutError(f"å·¥å…·è°ƒç”¨è¶…æ—¶: {tool_name}")
```

### 3. æ€§èƒ½æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | é‡æ„å‰ | é‡æ„å | æ”¹å–„å¹…åº¦ |
|------|--------|--------|----------|
| å¯åŠ¨æ—¶é—´ | å‡ ç§’åˆ°å‡ åˆ†é’Ÿ | < 10ç§’ | 70%+ |
| è¿æ¥ç¨³å®šæ€§ | éšæœºæ–­å¼€ | è‡ªåŠ¨æ¢å¤ | æ˜¾è‘—æå‡ |
| è·¯ç”±ä¸€è‡´æ€§ | ä¸åŒæ­¥ | å®Œå…¨åŒæ­¥ | 100% |
| å¹¶å‘æ€§èƒ½ | ä¸²è¡Œè¿æ¥ | å¹¶å‘è¿æ¥ | 3-5å€ |
| å†…å­˜ä½¿ç”¨ | é‡å¤åˆ›å»ºHub | è¿æ¥å¤ç”¨ | 50%+ |

## ğŸš€ æ‰©å±•æ€§è®¾è®¡

### 1. æ’ä»¶åŒ–MCPæœåŠ¡å™¨
```python
# æ”¯æŒå¤šç§ä¼ è¾“åè®®
class MCPTransportFactory:
    @staticmethod
    def create_transport(transport_type: str, config: Dict) -> MCPTransport:
        if transport_type == "stdio":
            return StdioTransport(config)
        elif transport_type == "http":
            return HttpTransport(config)
        elif transport_type == "sse":
            return SSETransport(config)
        else:
            raise ValueError(f"ä¸æ”¯æŒçš„ä¼ è¾“ç±»å‹: {transport_type}")
```

### 2. ç›‘æ§å’Œè¯Šæ–­
```python
# è¿æ¥æ± çŠ¶æ€ç›‘æ§
@router.get("/mcp/diagnostics")
async def get_diagnostics(current_user: User = Depends(get_current_user)):
    pool_status = {
        "total_connections": len(connection_pool._connections.get(current_user.id, {})),
        "healthy_connections": 0,
        "connection_details": []
    }
    
    user_connections = connection_pool._connections.get(current_user.id, {})
    for server_id, hub in user_connections.items():
        status = connection_pool.get_connection_status(server_id, current_user.id)
        pool_status["connection_details"].append({
            "server_id": server_id,
            "status": status,
            "healthy": status == "connected"
        })
        
        if status == "connected":
            pool_status["healthy_connections"] += 1
    
    return api_response(data=pool_status)
```

## ğŸ¯ å…³é”®è®¾è®¡å†³ç­–

### 1. ä¸ºä»€ä¹ˆä½¿ç”¨å…¨å±€è¿æ¥æ± ï¼Ÿ
- **é—®é¢˜**ï¼šåŸæ¥æ¯æ¬¡èŠå¤©éƒ½åˆ›å»ºæ–°Hubï¼Œå¯¼è‡´è¿æ¥ä¸ç¨³å®š
- **è§£å†³**ï¼šå…¨å±€å•ä¾‹è¿æ¥æ± ï¼Œç¡®ä¿è¿æ¥å¤ç”¨å’ŒçŠ¶æ€ä¸€è‡´æ€§
- **ä¼˜åŠ¿**ï¼šæé«˜æ€§èƒ½ï¼Œå‡å°‘èµ„æºæ¶ˆè€—ï¼Œå¢å¼ºç¨³å®šæ€§

### 2. ä¸ºä»€ä¹ˆé‡‡ç”¨ç”¨æˆ·éš”ç¦»ï¼Ÿ
- **é—®é¢˜**ï¼šå¤šç”¨æˆ·ç¯å¢ƒä¸‹çš„æ•°æ®å®‰å…¨å’Œæƒé™æ§åˆ¶
- **è§£å†³**ï¼šæ¯ä¸ªç”¨æˆ·ç‹¬ç«‹çš„è¿æ¥ç©ºé—´å’Œé…ç½®
- **ä¼˜åŠ¿**ï¼šæ•°æ®å®‰å…¨ï¼Œæƒé™æ¸…æ™°ï¼Œæ•…éšœéš”ç¦»

### 3. ä¸ºä»€ä¹ˆä½¿ç”¨å¼‚æ­¥æ¶æ„ï¼Ÿ
- **é—®é¢˜**ï¼šåŒæ­¥æ“ä½œå¯¼è‡´é˜»å¡å’Œæ€§èƒ½é—®é¢˜
- **è§£å†³**ï¼šå…¨å¼‚æ­¥è®¾è®¡ï¼Œéé˜»å¡I/Oæ“ä½œ
- **ä¼˜åŠ¿**ï¼šé«˜å¹¶å‘ï¼Œå“åº”å¿«é€Ÿï¼Œç”¨æˆ·ä½“éªŒå¥½

### 4. ä¸ºä»€ä¹ˆéœ€è¦å¥åº·æ£€æŸ¥ï¼Ÿ
- **é—®é¢˜**ï¼šè¿æ¥å¯èƒ½å› ç½‘ç»œç­‰åŸå› æ–­å¼€
- **è§£å†³**ï¼šå®šæœŸå¥åº·æ£€æŸ¥å’Œè‡ªåŠ¨é‡è¿æœºåˆ¶
- **ä¼˜åŠ¿**ï¼šè‡ªåŠ¨æ•…éšœæ¢å¤ï¼Œæé«˜ç³»ç»Ÿå¯é æ€§

## ğŸ“ æ€»ç»“

è¿™ä¸ªMCPæœåŠ¡æ¶æ„è®¾è®¡é€šè¿‡ä»¥ä¸‹å…³é”®æŠ€æœ¯è§£å†³äº†åŸæœ‰çš„é—®é¢˜ï¼š

1. **å…¨å±€è¿æ¥æ± **ï¼šç¡®ä¿è¿æ¥ä¸€è‡´æ€§å’Œå¤ç”¨
2. **ç”¨æˆ·éš”ç¦»**ï¼šä¿è¯æ•°æ®å®‰å…¨å’Œæƒé™æ§åˆ¶
3. **å¼‚æ­¥æ¶æ„**ï¼šæé«˜å¹¶å‘æ€§èƒ½å’Œå“åº”é€Ÿåº¦
4. **å¥åº·ç›‘æ§**ï¼šè‡ªåŠ¨æ•…éšœæ£€æµ‹å’Œæ¢å¤
5. **åˆ†å±‚è®¾è®¡**ï¼šæ¸…æ™°çš„èŒè´£åˆ†ç¦»å’Œå¯ç»´æŠ¤æ€§

é€šè¿‡è¿™äº›è®¾è®¡ï¼ŒMCPæœåŠ¡ç°åœ¨å…·å¤‡äº†**é«˜å¯ç”¨æ€§**ã€**é«˜æ€§èƒ½**å’Œ**è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒ**ï¼ŒåŒæ—¶ä¿æŒäº†ä»£ç çš„**å¯ç»´æŠ¤æ€§**å’Œ**å¯æ‰©å±•æ€§**ã€‚ 