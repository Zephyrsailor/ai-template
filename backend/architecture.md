# AI聊天应用架构文档

## 架构概述

本项目采用分层架构设计，清晰地划分各组件职责，实现高内聚低耦合的系统结构。主要分为以下几层：

```
backend/
├── app/                       # 应用主目录
│   ├── api/                   # API层 - 处理HTTP请求/响应
│   ├── core/                  # 核心层 - 应用核心功能
│   ├── services/              # 服务层 - 业务逻辑实现
│   ├── domain/                # 领域层 - 模型和常量
│   ├── lib/                   # 库层 - 通用组件和第三方集成
│   └── utils/                 # 工具层 - 通用工具函数
└── tests/                     # 测试目录
```

## 各层职责

### API层 (`app/api/`)

负责处理HTTP请求、输入验证和响应格式化。API层不应包含业务逻辑，而是将请求委托给服务层处理。

- **routes/**: API路由定义
- **deps.py**: API依赖注入

### 核心层 (`app/core/`)

应用骨架和框架级组件，如配置、安全、错误处理和全局依赖。

- **config.py**: 配置管理
- **security.py**: 安全机制
- **errors.py**: 错误处理
- **dependencies.py**: 全局依赖注入

### 服务层 (`app/services/`)

实现业务逻辑，协调各组件工作。服务层是应用的核心，包含所有业务流程的实现。

- **chat.py**: 聊天服务
- **knowledge.py**: 知识库服务
- **mcp.py**: MCP工具服务

### 领域层 (`app/domain/`)

定义业务实体、数据验证模型和业务常量。

- **models/**: 数据模型
- **schemas/**: Pydantic数据验证模型
- **constants.py**: 业务常量和枚举

### 库层 (`app/lib/`)

通用组件和第三方集成，如数据库连接、外部API封装等。

- **mcp/**: MCP客户端实现
- **knowledge/**: 知识库处理实现
- **providers/**: 外部服务提供者

### 工具层 (`app/utils/`)

通用工具函数，可被其他层复用的辅助功能。

## 数据流

1. 客户端请求经由API层接收
2. API层验证输入并调用服务层
3. 服务层实现业务逻辑，必要时调用库层
4. 服务层返回结果给API层
5. API层格式化响应并返回给客户端

## 依赖注入

本项目使用FastAPI的依赖注入系统来管理组件依赖。核心依赖在`app/core/dependencies.py`定义，API级别的依赖在`app/api/deps.py`定义。

## 特殊组件

### MCP (Model Client Protocol)

MCP是一个工具和资源管理组件，提供以下功能：

- 工具发现和调用
- 提示模板管理
- 资源访问

MCP组件设计为可独立运行，与知识库系统并列，为聊天系统提供工具能力增强。

### 知识库系统

知识库系统负责管理文档和检索，提供以下功能：

- 知识库管理（创建、删除、查询）
- 文档上传和处理
- 向量检索和相似度搜索

## 接口说明

主要接口包括：

- `/api/chat/stream`: 聊天流API
- `/api/knowledge/*`: 知识库管理API
- `/api/tools/*`: 工具管理和调用API

## 扩展指南

1. **添加新服务**: 在`app/services/`目录下创建新的服务类
2. **添加新API**: 在`app/api/routes/`目录下创建新的路由模块
3. **添加新模型**: 在`app/domain/schemas/`目录下定义新的Pydantic模型
4. **添加新工具**: 在MCP系统中注册新工具 